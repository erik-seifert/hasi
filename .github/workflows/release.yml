name: Build and Release

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux-snap:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libblkid-dev liblzma-dev libnm-dev libsecret-1-dev libunistring-dev
          flutter pub get
      - name: Install Snapcraft
        run: sudo snap install snapcraft --classic
      - name: Build Snap
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          command: sudo -E snapcraft pack --destructive-mode
          retry_on: error
      - name: Upload Snap Artifact
        uses: actions/upload-artifact@v4
        with:
          name: snap-artifact
          path: '*.snap'

  build-linux-appimage:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libblkid-dev liblzma-dev libnm-dev libsecret-1-dev libunistring-dev
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Linux
        run: flutter build linux --release
      
      - name: Download appimagetool
        run: |
          curl -LO https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod a+x appimagetool-x86_64.AppImage
          
      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/applications
          
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
          cp assets/logo.png AppDir/usr/share/icons/hicolor/256x256/apps/hasi.png
          cp assets/logo.png AppDir/hasi.png
          
          cat <<EOF > AppDir/usr/share/applications/hasi.desktop
          [Desktop Entry]
          Name=HASI
          Exec=hasi
          Icon=hasi
          Type=Application
          Categories=Utility;
          Terminal=false
          EOF
          
          cp AppDir/usr/share/applications/hasi.desktop AppDir/hasi.desktop
          
          cat <<EOF > AppDir/AppRun
          #!/bin/sh
          SELF=\$(readlink -f "\$0")
          HERE=\${SELF%/*}
          export PATH="\$HERE/usr/bin:\$PATH"
          export LD_LIBRARY_PATH="\$HERE/usr/bin/lib:\$LD_LIBRARY_PATH"
          exec "\$HERE/usr/bin/hasi" "\$@"
          EOF
          chmod +x AppDir/AppRun
          
      - name: Build AppImage
        run: |
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir HASI-x86_64.AppImage
        env:
          APPIMAGE_EXTRACT_AND_RUN: 1
          
      - name: Upload AppImage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: appimage-artifact
          path: HASI-x86_64.AppImage
 
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build Windows
        run: flutter build windows --release
      
      - name: Build MSIX
        run: flutter pub run msix:create
      
      - name: Prepare Assets
        run: |
          copy build\windows\x64\runner\Release\hasi.msix HASI-windows.msix
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath HASI-windows-bundle.zip
      
      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifact
          path: |
            HASI-windows.msix
            HASI-windows-bundle.zip

  release:
    needs: [build-linux-snap, build-linux-appimage, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))
    steps:
      - uses: actions/checkout@v4
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Flatten Artifacts
        run: |
          mkdir -p release_files
          find artifacts -type f -exec cp {} release_files/ \;
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || 'latest-dev' }}
          name: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || 'Latest Dev Build' }}
          files: release_files/*
          generate_release_notes: true
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/v') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Find Snap File
        id: find_snap
        run: echo "SNAP_FILE=$(find release_files -name '*.snap' | head -n 1)" >> $GITHUB_ENV

      - name: Install Snapcraft
        if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
        run: sudo snap install snapcraft --classic

      - name: Publish to Snap Store
        if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            SNAP_FILE=$(find release_files -name '*.snap' | head -n 1)
            CHANNEL=${{ startsWith(github.ref, 'refs/tags/v') && 'stable' || 'edge' }}
            sudo -E snapcraft push $SNAP_FILE --release $CHANNEL --destructive-mode
          retry_on: error
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
